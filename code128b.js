
const QUIET_COUNT = 10;
const START_VALUE = 104;
const STOP_VALUE = 106;
const barbitstring = Object.freeze({
  "0": "11011001100",
  "1": "11001101100",
  "2": "11001100110",
  "3": "10010011000",
  "4": "10010001100",
  "5": "10001001100",
  "6": "10011001000",
  "7": "10011000100",
  "8": "10001100100",
  "9": "11001001000",
  "10": "11001000100",
  "11": "11000100100",
  "12": "10110011100",
  "13": "10011011100",
  "14": "10011001110",
  "15": "10111001100",
  "16": "10011101100",
  "17": "10011100110",
  "18": "11001110010",
  "19": "11001011100",
  "20": "11001001110",
  "21": "11011100100",
  "22": "11001110100",
  "23": "11101101110",
  "24": "11101001100",
  "25": "11100101100",
  "26": "11100100110",
  "27": "11101100100",
  "28": "11100110100",
  "29": "11100110010",
  "30": "11011011000",
  "31": "11011000110",
  "32": "11000110110",
  "33": "10100011000",
  "34": "10001011000",
  "35": "10001000110",
  "36": "10110001000",
  "37": "10001101000",
  "38": "10001100010",
  "39": "11010001000",
  "40": "11000101000",
  "41": "11000100010",
  "42": "10110111000",
  "43": "10110001110",
  "44": "10001101110",
  "45": "10111011000",
  "46": "10111000110",
  "47": "10001110110",
  "48": "11101110110",
  "49": "11010001110",
  "50": "11000101110",
  "51": "11011101000",
  "52": "11011100010",
  "53": "11011101110",
  "54": "11101011000",
  "55": "11101000110",
  "56": "11100010110",
  "57": "11101101000",
  "58": "11101100010",
  "59": "11100011010",
  "60": "11101111010",
  "61": "11001000010",
  "62": "11110001010",
  "63": "10100110000",
  "64": "10100001100",
  "65": "10010110000",
  "66": "10010000110",
  "67": "10000101100",
  "68": "10000100110",
  "69": "10110010000",
  "70": "10110000100",
  "71": "10011010000",
  "72": "10011000010",
  "73": "10000110100",
  "74": "10000110010",
  "75": "11000010010",
  "76": "11001010000",
  "77": "11110111010",
  "78": "11000010100",
  "79": "10001111010",
  "80": "10100111100",
  "81": "10010111100",
  "82": "10010011110",
  "83": "10111100100",
  "84": "10011110100",
  "85": "10011110010",
  "86": "11110100100",
  "87": "11110010100",
  "88": "11110010010",
  "89": "11011011110",
  "90": "11011110110",
  "91": "11110110110",
  "92": "10101111000",
  "93": "10100011110",
  "94": "10001011110",
  "95": "10111101000",
  "96": "10111100010",
  "97": "11110101000",
  "98": "11110100010",
  "99": "10111011110",
  "100": "10111101110",
  "101": "11101011110",
  "102": "11110101110",
  "103": "11010000100",
  "104": "11010010000",
  "105": "11010011100",
  "106": "11000111010"
});
const characters = Object.freeze({
  "0": " ",
  "1": "!",
  "2": "\"",
  "3": "#",
  "4": "$",
  "5": "%",
  "6": "&",
  "7": "'",
  "8": "(",
  "9": ")",
  "10": "*",
  "11": "+",
  "12": ",",
  "13": "-",
  "14": ".",
  "15": "/",
  "16": "0",
  "17": "1",
  "18": "2",
  "19": "3",
  "20": "4",
  "21": "5",
  "22": "6",
  "23": "7",
  "24": "8",
  "25": "9",
  "26": ":",
  "27": ";",
  "28": "<",
  "29": "=",
  "30": ">",
  "31": "?",
  "32": "@",
  "33": "A",
  "34": "B",
  "35": "C",
  "36": "D",
  "37": "E",
  "38": "F",
  "39": "G",
  "40": "H",
  "41": "I",
  "42": "J",
  "43": "K",
  "44": "L",
  "45": "M",
  "46": "N",
  "47": "O",
  "48": "P",
  "49": "Q",
  "50": "R",
  "51": "S",
  "52": "T",
  "53": "U",
  "54": "V",
  "55": "W",
  "56": "X",
  "57": "Y",
  "58": "Z",
  "59": "[",
  "60": "\\",
  "61": "]",
  "62": "^",
  "63": "_",
  "64": "`",
  "65": "a",
  "66": "b",
  "67": "c",
  "68": "d",
  "69": "e",
  "70": "f",
  "71": "g",
  "72": "h",
  "73": "i",
  "74": "j",
  "75": "k",
  "76": "l",
  "77": "m",
  "78": "n",
  "79": "o",
  "80": "p",
  "81": "q",
  "82": "r",
  "83": "s",
  "84": "t",
  "85": "u",
  "86": "v",
  "87": "w",
  "88": "x",
  "89": "y",
  "90": "z",
  "91": "{",
  "92": "|",
  "93": "}",
  "94": "~",
  "95": "\u007F"
});
const characterValues = Object.freeze(Object.fromEntries(
  Object
    .entries(characters)
    .map(pair => [pair[1], pair[0]])));

function toBars(bitString) {
  return Array
    .from(bitString)
    .map(c => c === "1");
}

function toValues(string) {
  return Array
    .from(string)
    .map(character => characterValues[character]);
}

const bars = Object.freeze(Object.fromEntries(
  Object.keys(barbitstring)
    .map(key => [key, toBars(barbitstring[key])])));

function checkValue(values) {
  const sum = values.reduce(
    (total, value, index) => total + value * (index + 1),
    104);
  return sum % 103;
}

function code128bars(values) {
  return [
    Array(QUIET_COUNT).fill(false),
    bars[START_VALUE],
    values.map(value => bars[value]).flat(),
    bars[checkValue(values)],
    bars[STOP_VALUE],
    [true, true],
    Array(QUIET_COUNT).fill(false),
  ].flat();
}

function toRuns(values) {
  var last = {"index": -1, "count": 0, "value": function() {}};
  const runs = [];
  values.forEach(function(value, index) {
    if (value != last["value"]) {
      last = {index, "count": 1, value};
      runs.push(last);
    } else {
      last["count"] = last["count"] + 1;
    }
  })
  return runs;
}